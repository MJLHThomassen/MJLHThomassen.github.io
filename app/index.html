<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Todo List App</title>
    <link rel="stylesheet" href="styles.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
    <div id="todo-app">
        <h1>Todo Lists Manager</h1>

        <!-- Loading indicator - shown until Alpine.js loads -->
        <div class="loading-container" id="loading-indicator">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>

        <!-- Main app content - hidden until Alpine.js loads -->
        <div x-data="todoApp()" x-cloak x-ref="app">
            <!-- Modal for creating/renaming lists -->
            <div x-show="modal.show" x-cloak class="modal-overlay" @click.self="closeModal()">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" x-text="modal.title"></h3>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="modal-input" x-model="modal.input" :placeholder="modal.placeholder"
                            @keyup.enter="confirmModal()" @keyup.escape="closeModal()" x-ref="modalInput">
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn modal-btn-secondary" @click="closeModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" @click="confirmModal()">
                            <span x-text="modal.confirmText"></span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="list-controls">
                <div class="list-selector">
                    <select id="list-select" x-model="currentListId" @change="switchList()">
                        <template x-for="(list, listId) in lists" :key="listId">
                            <option :value="listId" x-text="list.name"></option>
                        </template>
                    </select>
                </div>
                <div class="list-buttons">
                    <button class="list-btn new-list-btn" @click="createNewList()">+ New</button>
                    <button class="list-btn rename-list-btn" @click="renameCurrentList()">‚úèÔ∏è</button>
                    <button class="list-btn delete-list-btn" @click="deleteCurrentList()">üóëÔ∏è</button>
                </div>
            </div>

            <div class="todo-controls">
                <input type="text" x-model="newTodoText" @keyup.enter="addTodo()" placeholder="Add a new task..." />
                <button @click="addTodo()">Add</button>
            </div>

            <div class="search-controls">
                <input type="text" x-model="searchQuery" placeholder="Search tasks..." />
            </div>

            <ul>
                <template x-for="(todo, index) in filteredTodos" :key="index">
                    <li :class="{ 'completed': todo.completed }"
                        x-show="!searchQuery || todo.text.toLowerCase().includes(searchQuery.toLowerCase())">
                        <input type="checkbox" class="todo-checkbox" x-model="todo.completed"
                            @change="toggleTodo(index)">

                        <span class="todo-content" @click="toggleTodo(index)" x-show="editingIndex !== index">
                            <span x-text="todo.text"></span>
                            <div class="tooltip" x-text="getTooltipText(todo)"></div>
                        </span>

                        <input type="text" class="todo-input" x-model="editText" x-show="editingIndex === index"
                            @keyup.enter="saveEdit(index)" @keyup.escape="cancelEdit()" @blur="saveEdit(index)">

                        <div class="button-group" x-show="editingIndex !== index">
                            <button class="edit-btn" @click="startEdit(index, todo.text)" title="Edit">‚úèÔ∏è</button>
                            <button class="delete-btn" @click="deleteTodo(index)" title="Delete">üóëÔ∏è</button>
                        </div>

                        <div class="button-group" x-show="editingIndex === index">
                            <button class="edit-btn" @click="saveEdit(index)" title="Save">‚úì</button>
                            <button class="delete-btn" @click="cancelEdit()" title="Cancel">‚úï</button>
                        </div>
                    </li>
                </template>
            </ul>
        </div>
    </div>

    <script>
        function todoApp()
        {
            return {
                currentListId: 'default',
                lists: {},
                newTodoText: '',
                searchQuery: '',
                editingIndex: -1,
                editText: '',

                // Modal state
                modal: {
                    show: false,
                    title: '',
                    placeholder: '',
                    confirmText: '',
                    input: '',
                    onConfirm: null
                },

                init()
                {
                    this.initializeLists();
                    // Hide loading indicator once Alpine is ready
                    this.$nextTick(() =>
                    {
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator)
                        {
                            loadingIndicator.style.display = 'none';
                        }
                    });
                },

                get currentList()
                {
                    return this.lists[this.currentListId] || { name: 'Default', todos: [] };
                },

                get filteredTodos()
                {
                    const todos = this.currentList.todos || [];
                    if (!this.searchQuery) return todos;
                    return todos.filter(todo =>
                        todo.text.toLowerCase().includes(this.searchQuery.toLowerCase())
                    );
                },

                // Modal functions
                openModal(title, placeholder, confirmText, initialValue = '', onConfirm = null)
                {
                    this.modal.title = title;
                    this.modal.placeholder = placeholder;
                    this.modal.confirmText = confirmText;
                    this.modal.input = initialValue;
                    this.modal.onConfirm = onConfirm;
                    this.modal.show = true;

                    // Focus input after modal is shown
                    this.$nextTick(() =>
                    {
                        this.$refs.modalInput.focus();
                        if (this.modal.input)
                        {
                            this.$refs.modalInput.select();
                        }
                    });
                },

                closeModal()
                {
                    this.modal.show = false;
                    this.modal.input = '';
                    this.modal.onConfirm = null;
                },

                confirmModal()
                {
                    if (!this.modal.input.trim()) return;

                    if (this.modal.onConfirm)
                    {
                        this.modal.onConfirm(this.modal.input.trim());
                    }

                    this.closeModal();
                },

                initializeLists()
                {
                    const savedLists = JSON.parse(localStorage.getItem('todoLists')) || {};
                    const savedCurrentListId = localStorage.getItem('currentListId');

                    if (Object.keys(savedLists).length === 0)
                    {
                        this.lists = {
                            'default': {
                                name: 'My Todo List',
                                todos: JSON.parse(localStorage.getItem('todos')) || []
                            }
                        };
                        this.currentListId = 'default';
                        localStorage.removeItem('todos');
                    } else
                    {
                        this.lists = savedLists;
                        if (savedCurrentListId && this.lists[savedCurrentListId])
                        {
                            this.currentListId = savedCurrentListId;
                        } else
                        {
                            this.currentListId = Object.keys(this.lists)[0];
                        }
                    }
                    this.saveLists();
                    this.saveCurrentListId();
                },

                saveLists()
                {
                    localStorage.setItem('todoLists', JSON.stringify(this.lists));
                },

                saveCurrentListId()
                {
                    localStorage.setItem('currentListId', this.currentListId);
                },

                addTodo()
                {
                    if (!this.newTodoText.trim()) return;

                    if (!this.lists[this.currentListId])
                    {
                        this.lists[this.currentListId] = { name: 'New List', todos: [] };
                    }

                    const todo = {
                        text: this.newTodoText.trim(),
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null
                    };

                    this.lists[this.currentListId].todos.push(todo);
                    this.newTodoText = '';
                    this.saveLists();
                },

                toggleTodo(index)
                {
                    const todo = this.currentList.todos[index];
                    if (!todo) return;

                    todo.completed = !todo.completed;
                    todo.completedAt = todo.completed ? new Date().toISOString() : null;
                    this.saveLists();
                },

                startEdit(index, text)
                {
                    this.editingIndex = index;
                    this.editText = text;
                    this.$nextTick(() =>
                    {
                        const input = this.$el.querySelector('.todo-input');
                        if (input)
                        {
                            input.focus();
                            input.select();
                        }
                    });
                },

                saveEdit(index)
                {
                    if (this.editingIndex === -1) return;

                    const todo = this.currentList.todos[index];
                    if (todo && this.editText.trim() && this.editText.trim() !== todo.text)
                    {
                        todo.text = this.editText.trim();
                        this.saveLists();
                    }
                    this.cancelEdit();
                },

                cancelEdit()
                {
                    this.editingIndex = -1;
                    this.editText = '';
                },

                deleteTodo(index)
                {
                    if (!this.currentList.todos[index]) return;
                    this.currentList.todos.splice(index, 1);
                    this.saveLists();
                },

                createNewList()
                {
                    this.openModal(
                        'Create New List',
                        'Enter list name...',
                        'Create',
                        '',
                        (name) =>
                        {
                            const listId = 'list_' + Date.now();
                            this.lists[listId] = {
                                name: name,
                                todos: []
                            };
                            this.currentListId = listId;
                            this.saveLists();
                            this.saveCurrentListId();
                        }
                    );
                },

                renameCurrentList()
                {
                    const currentName = this.currentList.name;
                    this.openModal(
                        'Rename List',
                        'Enter new list name...',
                        'Rename',
                        currentName,
                        (newName) =>
                        {
                            if (newName !== this.currentList.name)
                            {
                                this.lists[this.currentListId].name = newName;
                                this.saveLists();
                            }
                        }
                    );
                },

                deleteCurrentList()
                {
                    if (Object.keys(this.lists).length <= 1)
                    {
                        alert('Cannot delete the last list!');
                        return;
                    }

                    const listName = this.currentList.name;
                    if (confirm(`Are you sure you want to delete "${listName}"?`))
                    {
                        delete this.lists[this.currentListId];
                        this.currentListId = Object.keys(this.lists)[0];
                        this.saveLists();
                        this.saveCurrentListId();
                    }
                },

                switchList()
                {
                    this.searchQuery = '';
                    this.cancelEdit();
                    this.saveCurrentListId();
                },

                formatDate(dateString)
                {
                    if (!dateString) return null;
                    const date = new Date(dateString);
                    return date.toLocaleString();
                },

                getTooltipText(todo)
                {
                    let text = `Created: ${this.formatDate(todo.createdAt)}`;
                    if (todo.completedAt)
                    {
                        text += `\nCompleted: ${this.formatDate(todo.completedAt)}`;
                    }
                    return text;
                }
            }
        }
    </script>
</body>

</html>